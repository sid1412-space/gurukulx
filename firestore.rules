
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuth() {
      return request.auth != null;
    }

    function isUserId(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    // Check for role in custom claims, falling back to email for the admin.
    function isRole(role) {
        return isAuth() && request.auth.token.role == role;
    }

    function isAdmin() {
      return isAuth() && request.auth.token.email == 'gurukulxconnect@yahoo.com';
    }

    // AUTHENTICATED USER CHECKS
    // These functions combine role checks for cleaner rules.
    function isOwner(userId) {
      return isUserId(userId);
    }
    
    function isTutor() {
        return isRole('tutor');
    }
    
    function isStudent() {
        return isRole('student');
    }

    // --- COLLECTION RULES ---

    // Users can be read by anyone authenticated, but only modified by the owner or an admin.
    match /users/{userId} {
      allow read: if isAuth() || isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow create: if isAuth(); // On signup
      allow delete: if isAdmin();
    }
    
    // Sessions can be created by students. Read/Update only by participants or admin.
    match /sessions/{sessionId} {
        allow read, update: if isAdmin() || (isAuth() && (resource.data.studentId == request.auth.uid || resource.data.tutorId == request.auth.uid));
        allow create: if isStudent() || isAdmin();
    }

    // Session requests can be created by students. Read/Update/Delete by the target tutor or admin.
    match /sessionRequests/{requestId} {
        allow create: if isStudent() || isAdmin();
        allow read, update, delete: if isTutor() || isAdmin();
    }

    // Recharge requests can be created by students. Only admins can read/update them.
    match /rechargeRequests/{rechargeId} {
        allow create: if isStudent() || isAdmin();
        allow read, update, delete: if isAdmin();
    }
    
    // Payout requests can be created by tutors. Only admins can read/delete them.
    match /payoutRequests/{payoutRequestId} {
        allow create: if isTutor() || isAdmin();
        allow read, delete: if isAdmin();
    }
    
    // Payouts can only be read and created by admins.
    match /payouts/{payoutId} {
        allow read, create: if isAdmin();
    }
  }
}
