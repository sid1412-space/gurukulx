
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function for admin check
    function isAdmin() {
      // In a real app, use custom claims: request.auth.token.admin == true
      return request.auth != null && request.auth.token.email == 'gurukulxconnect@yahoo.com';
    }
    
    // Helper function to check ownership
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    match /users/{userId} {
      // ANY authenticated user can READ any user profile.
      // This is needed so students can see tutor profiles and vice-versa.
      // Sensitive data should not be in the main user document if it needs to be private,
      // or should be protected by more specific rules in subcollections.
      allow read: if request.auth != null;
      
      // Users can only WRITE to their own document.
      allow write: if isOwner(userId) || isAdmin();
    }
    
    match /sessionRequests/{requestId} {
      // Tutors can read requests made to them
      allow read: if request.auth.uid == resource.data.tutorId;
      // Students can read requests they made
      allow read: if request.auth.uid == resource.data.studentId;
      
      // Students can create requests
      allow create: if request.auth.uid == request.resource.data.studentId;

      // Tutors can update requests (accept/reject)
      allow update: if request.auth.uid == resource.data.tutorId;
      
      // Students or Tutors can delete (cancel) requests
      allow delete: if request.auth.uid == resource.data.studentId || request.auth.uid == resource.data.tutorId;
    }
    
     match /rechargeRequests/{rechargeId} {
        // Admins can read/update all requests
        allow read, update: if isAdmin();
        // Students can create their own recharge requests
        allow create: if request.auth.uid == request.resource.data.studentId;
     }

     match /payoutRequests/{payoutId} {
        // Admins can read/update all requests
        allow read, update: if isAdmin();
        // Tutors can create their own payout requests
        allow create: if request.auth.uid == request.resource.data.tutorId;
     }
     
      match /payouts/{payoutId} {
        // Tutors can read their own payout history
        allow read: if request.auth.uid == resource.data.tutorId;
     }

  }
}
